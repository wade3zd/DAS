DROP TABLE IF EXISTS `com_area`;

CREATE TABLE `com_area` (
  `id` int(10) unsigned NOT NULL auto_increment '区域: 省份/城市',
  `pid` int(10) unsigned default NULL,
  `name` varchar(100) default NULL,
  `lft` int(10) unsigned default NULL,
  `rgt` int(10) unsigned default NULL,
  PRIMARY KEY  (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=378 DEFAULT CHARSET=utf8;

/*Data for the table `com_area` */

insert  into `com_area`(`id`,`pid`,`name`,`lft`,`rgt`) values (1,0,'中国',1,754),(2,1,'北京',2,5),(3,2,'北京市',3,4),(4,1,'天津',6,9),(5,4,'天津市',7,8),(6,1,'河北',10,33),(7,6,'石家庄市',11,12),(8,6,'唐山市',13,14),(9,6,'秦皇岛市',15,16),(10,6,'邯郸市',17,18),(11,6,'邢台市',19,20),(12,6,'保定市',21,22),(13,6,'张家口市',23,24),(14,6,'承德市',25,26),(15,6,'沧州市',27,28),(16,6,'廊坊市',29,30),(17,6,'衡水市',31,32),(18,1,'山西',34,57),(19,18,'太原市',35,36),(20,18,'大同市',37,38),(21,18,'阳泉市',39,40),(22,18,'长治市',41,42),(23,18,'晋城',43,44),(24,18,'朔州市',45,46),(25,18,'忻州市',47,48),(26,18,'吕梁市',49,50),(27,18,'晋中市',51,52),(28,18,'临汾市',53,54),(29,18,'运城市',55,56),(30,1,'内蒙古',58,87),(31,30,'呼和浩特市',59,60),(32,30,'包头市',61,62),(33,30,'乌海市',63,64),(34,30,'赤峰市',65,66),(35,30,'呼伦贝尔',67,68),(36,30,'兴安盟',69,70),(37,30,'通辽市',71,72),(38,30,'锡林郭勒盟',73,74),(39,30,'乌兰察布盟',75,76),(40,30,'鄂尔多斯',77,78),(41,30,'巴彦淖尔盟',79,80),(42,30,'阿拉善盟',81,82),(43,30,'满洲里市',83,84),(44,30,'二连浩特市',85,86),(45,1,'辽宁',88,117),(46,45,'沈阳市',89,90),(47,45,'大连市',91,92),(48,45,'鞍山市',93,94),(49,45,'抚顺市',95,96),(50,45,'本溪市',97,98),(51,45,'丹东市',99,100),(52,45,'锦州市',101,102),(53,45,'营口市',103,104),(54,45,'阜新市',105,106),(55,45,'辽阳市',107,108),(56,45,'盘锦市',109,110),(57,45,'铁岭市',111,112),(58,45,'朝阳市',113,114),(59,45,'葫芦岛市',115,116),(60,1,'吉林',118,139),(61,60,'长春市',119,120),(62,60,'吉林市',121,122),(63,60,'四平市',123,124),(64,60,'辽源市',125,126),(65,60,'通化市',127,128),(66,60,'松原市',129,130),(67,60,'白城市',131,132),(68,60,'延边朝鲜族自治州',133,134),(69,60,'白山市',135,136),(70,60,'长白山',137,138),(71,1,'黑龙江',140,167),(72,71,'哈尔滨市',141,142),(73,71,'齐齐哈尔市',143,144),(74,71,'鸡西市',145,146),(75,71,'鹤岗市',147,148),(76,71,'双鸭山市',149,150),(77,71,'大庆市',151,152),(78,71,'伊春市',153,154),(79,71,'佳木斯市',155,156),(80,71,'七台河市',157,158),(81,71,'牡丹江市',159,160),(82,71,'黑河市',161,162),(83,71,'绥化市',163,164),(84,71,'大兴安岭地区',165,166),(85,1,'上海',168,171),(86,85,'上海市',169,170),(87,1,'江苏',172,199),(88,87,'南京市',173,174),(89,87,'无锡市',175,176),(90,87,'徐州市',177,178),(91,87,'常州市',179,180),(92,87,'苏州市',181,182),(93,87,'南通市',183,184),(94,87,'连云港市',185,186),(95,87,'淮安市',187,188),(96,87,'宿迁市',189,190),(97,87,'盐城市',191,192),(98,87,'扬州市',193,194),(99,87,'泰州市',195,196),(100,87,'镇江市',197,198),(101,1,'浙江',200,223),(102,101,'杭州市',201,202),(103,101,'宁波市',203,204),(104,101,'温州市',205,206),(105,101,'嘉兴市',207,208),(106,101,'湖州市',209,210),(107,101,'绍兴市',211,212),(108,101,'金华市',213,214),(109,101,'衢州市',215,216),(110,101,'舟山市',217,218),(111,101,'丽水市',219,220),(112,101,'台州市',221,222),(113,1,'安徽',224,257),(114,113,'合肥市',225,226),(115,113,'芜湖市',227,228),(116,113,'蚌埠市',229,230),(117,113,'淮南市',231,232),(118,113,'马鞍山市',233,234),(119,113,'淮北市',235,236),(120,113,'铜陵市',237,238),(121,113,'安庆市',239,240),(122,113,'黄山市',241,242),(123,113,'滁州市',243,244),(124,113,'阜阳市',245,246),(125,113,'宿州市',247,248),(126,113,'六安市',249,250),(127,113,'宣城市',251,252),(128,113,'池州市',253,254),(129,113,'亳州市',255,256),(130,1,'福建',258,277),(131,130,'福州市',259,260),(132,130,'厦门市',261,262),(133,130,'莆田市',263,264),(134,130,'三明市',265,266),(135,130,'泉州市',267,268),(136,130,'漳州市',269,270),(137,130,'南平地区',271,272),(138,130,'宁德地区',273,274),(139,130,'龙岩地区',275,276),(140,1,'江西',278,301),(141,140,'南昌市',279,280),(142,140,'景德镇市',281,282),(143,140,'萍乡市',283,284),(144,140,'九江市',285,286),(145,140,'新余市',287,288),(146,140,'鹰潭市',289,290),(147,140,'赣州市',291,292),(148,140,'宜春市',293,294),(149,140,'上饶市',295,296),(150,140,'吉安市',297,298),(151,140,'抚州市',299,300),(152,1,'山东',302,337),(153,152,'济南市',303,304),(154,152,'青岛市',305,306),(155,152,'淄博市',307,308),(156,152,'枣庄市',309,310),(157,152,'东营市',311,312),(158,152,'烟台市',313,314),(159,152,'潍坊市',315,316),(160,152,'济宁市',317,318),(161,152,'泰安市',319,320),(162,152,'威海市',321,322),(163,152,'日照市',323,324),(164,152,'莱芜市',325,326),(165,152,'滨州市',327,328),(166,152,'德州市',329,330),(167,152,'聊城市',331,332),(168,152,'临沂市',333,334),(169,152,'荷泽市',335,336),(170,1,'河南',338,375),(171,170,'郑州市',339,340),(172,170,'开封市',341,342),(173,170,'洛阳市',343,344),(174,170,'平顶山市',345,346),(175,170,'安阳市',347,348),(176,170,'鹤壁市',349,350),(177,170,'新乡市',351,352),(178,170,'焦作市',353,354),(179,170,'濮阳市',355,356),(180,170,'许昌市',357,358),(181,170,'漯河市',359,360),(182,170,'三门峡市',361,362),(183,170,'商丘市',363,364),(184,170,'周口市',365,366),(185,170,'驻马店市',367,368),(186,170,'南阳市',369,370),(187,170,'信阳市',371,372),(188,170,'济源市',373,374),(189,1,'湖北',376,411),(190,189,'武汉市',377,378),(191,189,'黄石市',379,380),(192,189,'十堰市',381,382),(193,189,'宜昌市',383,384),(194,189,'襄樊市',385,386),(195,189,'随州市',387,388),(196,189,'鄂州市',389,390),(197,189,'荆门市',391,392),(198,189,'孝感市',393,394),(199,189,'黄冈市',395,396),(200,189,'咸宁市',397,398),(201,189,'荆州市',399,400),(202,189,'仙桃市',401,402),(203,189,'天门市',403,404),(204,189,'潜江市',405,406),(205,189,'恩施土家族苗族自治州',407,408),(206,189,'神农架林区',409,410),(207,1,'湖南',412,441),(208,207,'长沙市',413,414),(209,207,'株州市',415,416),(210,207,'湘潭市',417,418),(211,207,'衡阳市',419,420),(212,207,'邵阳市',421,422),(213,207,'岳阳市',423,424),(214,207,'常德市',425,426),(215,207,'张家界市',427,428),(216,207,'益阳市',429,430),(217,207,'娄底市',431,432),(218,207,'郴州市',433,434),(219,207,'永州市',435,436),(220,207,'怀化市',437,438),(221,207,'湘西土家族苗族自治州',439,440),(222,1,'广东',442,485),(223,222,'广州市',443,444),(224,222,'韶关市',445,446),(225,222,'深圳市',447,448),(226,222,'珠海市',449,450),(227,222,'汕头市',451,452),(228,222,'佛山市',453,454),(229,222,'江门市',455,456),(230,222,'湛江市',457,458),(231,222,'茂名市',459,460),(232,222,'肇庆市',461,462),(233,222,'云浮市',463,464),(234,222,'惠州市',465,466),(235,222,'梅州市',467,468),(236,222,'汕尾市',469,470),(237,222,'河源市',471,472),(238,222,'阳江市',473,474),(239,222,'清远市',475,476),(240,222,'东莞市',477,478),(241,222,'中山市',479,480),(242,222,'潮州市',481,482),(243,222,'揭阳市',483,484),(244,1,'广西',486,515),(245,244,'南宁市',487,488),(246,244,'柳州市',489,490),(247,244,'桂林市',491,492),(248,244,'梧州市',493,494),(249,244,'北海市',495,496),(250,244,'防城港市',497,498),(251,244,'贺州市',499,500),(252,244,'崇左市',501,502),(253,244,'贵港市',503,504),(254,244,'来宾市',505,506),(255,244,'玉林市',507,508),(256,244,'百色市',509,510),(257,244,'河池市',511,512),(258,244,'钦州市',513,514),(259,1,'海南',516,521),(260,259,'海口市',517,518),(261,259,'三亚市',519,520),(262,1,'四川',522,565),(263,262,'成都市',523,524),(264,262,'自贡市',525,526),(265,262,'攀枝花市',527,528),(266,262,'泸州市',529,530),(267,262,'德阳市',531,532),(268,262,'绵阳市',533,534),(269,262,'广元市',535,536),(270,262,'遂宁市',537,538),(271,262,'内江市',539,540),(272,262,'乐山市',541,542),(273,262,'南充市',543,544),(274,262,'宜宾市',545,546),(275,262,'达州市',547,548),(276,262,'雅安市',549,550),(277,262,'阿坝藏族羌族自治州',551,552),(278,262,'甘孜藏族自治州',553,554),(279,262,'凉山彝族自治州',555,556),(280,262,'广安市',557,558),(281,262,'巴中市',559,560),(282,262,'眉山市',561,562),(283,262,'资阳市',563,564),(284,1,'贵州',566,585),(285,284,'贵阳市',567,568),(286,284,'六盘水市',569,570),(287,284,'遵义市',571,572),(288,284,'铜仁地区',573,574),(289,284,'毕节地区',575,576),(290,284,'安顺市',577,578),(291,284,'黔东南苗族侗族自治州',579,580),(292,284,'黔南布依族苗族自治州',581,582),(293,284,'黔西南布依族苗族自治州',583,584),(294,1,'云南',586,617),(295,294,'昆明市',587,588),(296,294,'昭通市',589,590),(297,294,'曲靖市',591,592),(298,294,'楚雄彝族自治州',593,594),(299,294,'玉溪市',595,596),(300,294,'红河哈尼族彝族自治州',597,598),(301,294,'文山壮族苗族自治州',599,600),(302,294,'西双版纳傣族自治州',601,602),(303,294,'大理白族自治州',603,604),(304,294,'保山市',605,606),(305,294,'德宏傣族景颇族自治州',607,608),(306,294,'丽江市',609,610),(307,294,'怒江傈僳族自治州',611,612),(308,294,'迪庆藏族自治州',613,614),(309,294,'临沧市',615,616),(310,1,'西藏',618,633),(311,310,'拉萨市',619,620),(312,310,'昌都地区',621,622),(313,310,'山南地区',623,624),(314,310,'日喀则地区',625,626),(315,310,'那曲地区',627,628),(316,310,'阿里地区',629,630),(317,310,'林芝地区',631,632),(318,1,'陕西',634,657),(319,318,'西安市',635,636),(320,318,'铜川市',637,638),(321,318,'宝鸡市',639,640),(322,318,'咸阳市',641,642),(323,318,'渭南市',643,644),(324,318,'汉中市',645,646),(325,318,'安康市',647,648),(326,318,'商洛市',649,650),(327,318,'延安市',651,652),(328,318,'榆林市',653,654),(329,318,'杨凌示范区',655,656),(330,1,'甘肃',658,687),(331,330,'兰州市',659,660),(332,330,'嘉峪关市',661,662),(333,330,'金昌市',663,664),(334,330,'白银市',665,666),(335,330,'天水市',667,668),(336,330,'酒泉市',669,670),(337,330,'张掖市',671,672),(338,330,'武威市',673,674),(339,330,'定西市',675,676),(340,330,'陇南市',677,678),(341,330,'平凉市',679,680),(342,330,'庆阳市',681,682),(343,330,'临夏回族自治州',683,684),(344,330,'甘南藏族自治州',685,686),(345,1,'青海',688,705),(346,345,'西宁市',689,690),(347,345,'海东行署',691,692),(348,345,'海北藏族自治州',693,694),(349,345,'黄南藏族自治州',695,696),(350,345,'海南藏族自治州',697,698),(351,345,'果洛藏族自治州',699,700),(352,345,'玉树藏族自治州',701,702),(353,345,'海西蒙古族藏族自治州',703,704),(354,1,'宁夏',706,717),(355,354,'银川市',707,708),(356,354,'石嘴山市',709,710),(357,354,'吴忠市',711,712),(358,354,'固原市',713,714),(359,354,'中卫市',715,716),(360,1,'新疆',718,749),(361,360,'乌鲁木齐市',719,720),(362,360,'克拉玛依市',721,722),(363,360,'吐鲁番地区',723,724),(364,360,'哈密地区',725,726),(365,360,'昌吉回族自治州',727,728),(366,360,'博尔塔拉蒙古自治州',729,730),(367,360,'巴音郭楞蒙古自治州',731,732),(368,360,'阿克苏地区',733,734),(369,360,'克孜勒苏柯尔克孜自治州',735,736),(370,360,'喀什地区',737,738),(371,360,'和田地区',739,740),(372,360,'伊犁哈萨克自治州',741,742),(373,360,'石河子市',743,744),(374,360,'塔城地区',745,746),(375,360,'阿勒泰地区',747,748),(376,1,'重庆',750,753),(377,376,'重庆市',751,752);


--------------------------------
SELECT node.name, node.lft, node.rgt
FROM com_area AS node, com_area AS parent
WHERE node.lft >= parent.lft and node.rgt <= parent.rgt AND parent.id = 1
ORDER BY node.lft;

SELECT CONCAT(REPEAT('  ', COUNT(parent.id)-1), node.name) AS name, node.id,node.lft,node.rgt, COUNT(parent.id) AS depth
FROM com_area AS node, com_area AS parent
where  node.lft BETWEEN parent.lft AND parent.rgt
group by node.id
ORDER BY node.lft;

select  node.name as name from com_area as node where lft>1 and rgt<20
select parent.name, parent.id from com_area as node, com_area as parent where node.lft BETWEEN parent.lft and parent.rgt and node.id=5;

--------------------------------

/* 调用 call com_area_pro(1,1,@k);select @k;*/
DELIMITER $$

DROP PROCEDURE IF EXISTS `com_area_pro`$$

CREATE DEFINER=`root`@`localhost` PROCEDURE `com_area_pro`(in _lft int,in fid int,out m int)
BEGIN
	declare _id int default 0;
	declare done int default 0;
	declare com_area_cursor cursor for select id from com_area where pid=fid;
	declare continue handler for sqlstate '02000' set done=1;
	SET m=_lft;
	set @@max_sp_recursion_depth =2000;
	open com_area_cursor;
	REPEAT
		FETCH com_area_cursor INTO _id;
		IF NOT done THEN
		  call com_area_pro(m+1,_id,m);
		  set m=m+1;
		END IF;
	UNTIL done END REPEAT;
	update com_area set lft=_lft,rgt=m+1 where id=fid;
    END$$

DELIMITER ;